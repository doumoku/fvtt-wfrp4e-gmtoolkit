{
  "_id": "rzKeTLKp0bOp5SK9",
  "name": "Add XP",
  "type": "script",
  "author": "k5y1jEYMBqd9uLUx",
  "img": "modules/wfrp4e-gm-toolkit/assets/icons/add-xp.svg",
  "scope": "global",
  "command": "addXP()\n\nasync function addXP () {\n\n  // Setup: determine group of actors to be awarded experience\n  let awardees = []\n  if (game.user.targets.size < 1) {\n    // (1) all assigned player characters\n    awardees = game.gmtoolkit.utility\n      .getGroup(game.settings.get(\"wfrp4e-gm-toolkit\", \"defaultPartySessionTurnover\"))\n      .filter(g => g.type === \"character\")\n  } else {\n    // (2) all targeted tokens of awardee selection\n    awardees = game.gmtoolkit.utility\n      .getGroup(game.settings.get(\"wfrp4e-gm-toolkit\", \"defaultPartySessionTurnover\"), { interaction: \"targeted\" })\n      .filter(g => g.type === \"character\")\n  }\n\n  // Setup: exit with notice if there are no player-owned characters\n  if (awardees.length < 1) return ui.notifications.error(game.i18n.localize(\"GMTOOLKIT.Token.TargetPCs\"), {})\n\n  // Get  session ID/date, default XP award and default reason\n  const XP = Number(game.settings.get(\"wfrp4e-gm-toolkit\", \"addXPDefaultAmount\"))\n  let reason = (game.settings.get(\"wfrp4e-gm-toolkit\", \"addXPDefaultReason\") === \"null\")\n    ? \"\"\n    : game.settings.get(\"wfrp4e-gm-toolkit\", \"addXPDefaultReason\")\n  if (reason) {\n    reason = game.settings.get(\"wfrp4e-gm-toolkit\", \"addXPDefaultReason\")\n    const session = game.gmtoolkit.utility.getSession()\n    reason = (session.date)\n      ? reason.replace(\"(%date%)\", `(${session.date})`)\n      : reason.replace(\" (%date%)\", \"\")\n    reason = (session.id !== \"null\" )\n      ? reason.replace(\"%session%\", session.id)\n      : reason = reason.replace(\"%session%\", \"\")\n  }\n\n  // Prompt for XP if option is set\n  (game.settings.get(\"wfrp4e-gm-toolkit\", \"addXPPrompt\"))\n    ? promptForXP( awardees, XP, reason )\n    : updateXP( awardees, XP, reason )\n\n} // END: addXP\n\nfunction updateXP (allAwardees, XP, reason) {\n  let chatContent = \"\"\n  const awardees = groupAwardees(allAwardees)\n  const awards = {\n    pc: XP,\n    henchman: (XP / 2) | 0\n  }\n\n  // Cycle through player characters, gathering experience change data for report message\n  if ( awardees.pcs.length > 0 ) {\n    chatContent += `<h3>${game.i18n.format(\"GMTOOLKIT.Dialog.AddXP.Awarded\", { award: awards.pc })}</h3><ul>`\n    awardees.pcs.forEach(character => {\n      applyAward(character, awards.pc)\n    }) // End cycle\n    chatContent += \"</ul>\"\n  }\n\n  // Cycle through henchmen, gathering experience change data for report message\n  if ( awardees.henchmen.length > 0 ) {\n    chatContent += `<h3>${game.i18n.format(\"GMTOOLKIT.Dialog.AddXP.Awarded\", { award: awards.henchman })}</h3><ul>`\n    awardees.henchmen.forEach(character => {\n      applyAward(character, awards.henchman)\n    }) // End cycle\n    chatContent += \"</ul>\"\n  }\n\n  // confirm changes made in whisper to GM\n  const chatData = game.wfrp4e.utility.chatDataSetup(chatContent, \"gmroll\", false)\n  chatData.flavor = game.i18n.format(\"GMTOOLKIT.AddXP.Flavor\", { reason })\n  ChatMessage.create(chatData, {})\n  console.log(chatContent)\n\n  // Update actor and build report\n  function applyAward (character, award) {\n    const recipient = character?.actor?.name || character.name\n    const XPTotal = character?.details?.experience?.total\n    const newXPTotal = Math.max(XPTotal + award, 0)\n    const XPCurrent = character?.details?.experience?.current || 0\n    const newXPCurrent = Math.max(XPCurrent + award, 0)\n\n    // Update token actor or actor\n    character?.actor\n      ? character.actor.system.awardExp(award, reason)\n      : character.system.awardExp(award, reason)\n\n    // Build report message\n    chatContent += `<li>${game.i18n.format(\"GMTOOLKIT.AddXP.Success\", { recipient, XPTotal, newXPTotal, XPCurrent, newXPCurrent })}</li>`\n  }\n} // END: updateXP\n\nfunction promptForXP (allAwardees, XP, reason) {\n  const awardees = groupAwardees(allAwardees)\n  const awardeeList = {}\n  let awardeeNotice = \"\"\n\n  // Build player character awardee list\n  if (awardees.pcs.length > 0) {\n    awardeeList.pcs = \"<ul>\"\n    awardees.pcs.forEach(character => {\n      awardeeList.pcs += `<li>${character?.actor?.name || character.name}</li>`\n    })\n    awardeeList.pcs += \"</ul>\"\n    awardeeNotice += `<p>${game.i18n.format(\"GMTOOLKIT.Dialog.AddXP.Recipients.Full\", { recipients: awardeeList.pcs })}</p>`\n  }\n\n  // Build henchmen awardee list\n  if (awardees.henchmen.length > 0) {\n    awardeeList.henchmen = \"<ul>\"\n    awardees.henchmen.forEach(character => {\n      awardeeList.henchmen += `<li>${character?.actor?.name || character.name}</li>`\n    })\n    awardeeList.henchmen += \"</ul>\"\n    awardeeNotice += `<p>${game.i18n.format(\"GMTOOLKIT.Dialog.AddXP.Recipients.Half\", { recipients: awardeeList.henchmen })}</p>`\n  }\n\n  const dialog = new Dialog({\n    title: game.i18n.localize(\"GMTOOLKIT.Dialog.AddXP.Title\"),\n    content: `<form>\n            ${awardeeNotice}\n            <div class=\"form-group\">\n              <label>${game.i18n.localize(\"GMTOOLKIT.Dialog.AddXP.Prompt\")}</label> \n              <input type=\"text\" id=\"add-xp\" name=\"add-xp\" value=\"${XP}\" />\n            </div>\n            <div class=\"form-group\">\n              <label>${game.i18n.localize(\"GMTOOLKIT.Dialog.AddXP.Reason\")}</label> \n              <input type=\"text\" id=\"xp-reason\" name=\"xp-reason\" value=\"${reason}\" />\n            </div>\n        </form>`,\n    buttons: {\n      yes: {\n        icon: \"<i class='fas fa-check'></i>\",\n        label: game.i18n.localize(\"GMTOOLKIT.Dialog.Apply\"),\n        callback: html => {\n          const XP = Math.round(html.find(\"#add-xp\").val())\n          if (isNaN(XP)) return ui.notifications.error(game.i18n.localize(\"GMTOOLKIT.Dialog.AddXP.InvalidXP\"))\n          const reason = html.find(\"#xp-reason\").val()\n          updateXP(allAwardees, XP, reason)\n        }\n      },\n      no: {\n        icon: \"<i class='fas fa-times'></i>\",\n        label: game.i18n.localize(\"GMTOOLKIT.Dialog.Cancel\")\n      }\n    },\n    default: \"yes\"\n  }).render(true)\n\n} // END: promptForXP\n\nfunction groupAwardees (allAwardees) {\n  const party = game.gmtoolkit.utility.getGroup(\"party\")\n  const henchmen = game.gmtoolkit.utility.getGroup(\"henchmen\")\n  const awardees = {\n    pcs: allAwardees.filter(character => party.includes(character)),\n    henchmen: allAwardees.filter(character => henchmen.includes(character))\n  }\n  return awardees\n} // END: groupAwardees\n\n\n/* ==========\n * MACRO: Add XP\n * VERSION: 8.0.0\n * UPDATED: 2024-09-08\n * DESCRIPTION: Adds a set amount of XP to all or targeted player character(s). Adds XP update note to the chat log.\n * TIP: Characters must have a player assigned (if default group is 'party') or be player-owned (if default group is 'company').\n * TIP: When default group is company, characters who are not assigned to a player are treated as henchmen, and receive half XP.\n * TIP: Default XP amount and reason can be preset in module settings, along with option to bypass prompt for XP amount each time.\n * TIP: Non-whole numbers are rounded off. Negative numbers are subtracted. Henchman awards are rounded down.\n ========== */",
  "folder": null,
  "sort": 0,
  "flags": {
    "wfrp4e-gm-toolkit": {
      "version": "8.0.0"
    }
  },
  "ownership": {
    "default": 0
  },
  "_stats": {
    "systemId": "wfrp4e",
    "systemVersion": "6.1.4",
    "coreVersion": "12.331",
    "createdTime": null,
    "modifiedTime": 1725809265780,
    "lastModifiedBy": "Pt7qzajGGC2jofTq",
    "compendiumSource": null,
    "duplicateSource": null
  },
  "_key": "!macros!rzKeTLKp0bOp5SK9"
}
